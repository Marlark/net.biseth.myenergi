<!DOCTYPE html>
<html>

<head>
    <!-- The '/homey.js' script must be included in your settings view to work -->
    <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>

<body>
    <h1 data-i18n="settings.title">
        <!-- This will be filled with the translated string with key 'settings.title'. -->
    </h1>
    <p data-i18n="settings.subtitle">
        <!-- This field will also be translated -->
    </p>

    <fieldset class="fieldset-api">
        <legend>myenergi API base URI</legend>

        <div class="field row">
            <label for="apiBaseUrl">Hub name</label>
            <input id="apiBaseUrl" name="apiBaseUrl" type="text" value="" placeholder="https://s18.myenergi.net" required
                pattern="@(https?)://(-\.)?([^\s/?\.#-]+\.?)+(/[^\s]*)?$@iS" />
        </div>
    </fieldset>

    <fieldset class="fieldset">
        <legend>myenergi Hub</legend>

        <div class="field row">
            <label for="hubname">Hub name</label>
            <input id="hubname" name="hubname" type="text" value="" required pattern="[a-zA-Z0-9]+" />
        </div>
        <div class="field row">
            <label for="username">Hub serial no</label>
            <input id="username" name="username" type="text" value="" required pattern="[0-9]*" inputmode="numeric" />
        </div>
        <div class="field row">
            <label for="password">Hub password</label>
            <input id="password" name="password" type="password" value="" />
        </div>
        <div class="field row">
            <label for="pollInterval">Server poll interval (sec)</label>
            <input id="pollInterval" name="pollInterval" type="number" min="5" max="86400" value="" />
            <br />
            <span>
                <i>
                    Note! Be careful not to use too short intervals. This could cause
                    you to be locked out from the myenergi API.
                </i>
            </span>
        </div>
        <div class="field row">
            <input type="hidden" name="hubIndex" id="hubIndex" value="0" />
            <button id="deleteHub" class="right deleteHub" data-hubIndex="0">Remove Hub</button>
        </div>
    </fieldset>

    <button id="addHub" class="left">Add Hub</button>
    <button id="saveHubs" class="right">Save changes</button>

    <!-- <textarea id="log" rows="10"></textarea> -->

    <script type="text/javascript">
        // a method named 'onHomeyReady' must be present in your code
        function onHomeyReady(Homey) {
            // Tell Homey we're ready to be displayed
            Homey.ready();

            var myenergiHubs = [];

            // Register delete hub buton click.
            function deleteHub(event) {
                //Calling function on click

                var hubIndex = event.data.hubIndex;
                Homey.confirm(`Do you want to delete this hub (${hubIndex})?`, 'warning', (error, result) => {
                    if (result) {
                        myenergiHubs.splice(hubIndex, 1);
                        populateFields();
                        Homey.alert(`Hub ${result} deleted!`, 'info', () => {

                        });
                    }
                });
            }

            //Function to replicate fields in the form
            function replicateFields() {
                var elementToReplicate = $('.fieldset').first(); //Only clone first group of inputs
                clonedElement = elementToReplicate.clone(); //Cloned the element
                var hubIndex = elementToReplicate.find('#hubIndex').val();
                hubIndex++;
                clonedElement.find('input').val(''); //Clear cloned elements value on each new addition
                clonedElement.find('.deleteHub').on('click', { hubIndex: hubIndex }, deleteHub);
                clonedElement.insertBefore($('#addHub'));
            }

            function removeFields() {
                var fieldCount = $('.fieldset').length
                for (let index = fieldCount - 1; index > 0; index--) {
                    $('.fieldset').last().remove();
                }
            }

            function populateFields() {
                var i = 0;
                removeFields();
                for (let i = 1; i < myenergiHubs.length; i++) {
                    replicateFields();
                }
                $('.fieldset').each(function () {
                    const hub = myenergiHubs[i++];
                    $(this).find('input[name="hubname"]').val(hub.hubname);
                    $(this).find('input[name="username"]').val(hub.username);
                    $(this).find('input[name="password"]').val(hub.password);
                    $(this)
                        .find('input[name="pollInterval"]')
                        .val(hub.pollInterval ? hub.pollInterval : 60);
                });
            }

            //Calling function on click
            $('#addHub').on('click', function () {
                populateFields();
            });

            $('.deleteHub').on('click', { hubIndex: 0 }, deleteHub);

            //Go through inputs filling up the array of arrays.
            $('#saveHubs').on('click', function () {
                myenergiHubs = [];
                $('.fieldset').each(function () {
                    const hubName = (
                        '' +
                        $(this).find('input[name="hubname"]').val() +
                        ''
                    ).replace(/[\W_]+/g, '_');
                    const userName = $(this).find('input[name="username"]').val();
                    const password = $(this).find('input[name="password"]').val();
                    let pollInterval = 60;
                    try {
                        pollInterval = Number(
                            $(this).find('input[name="pollInterval"]').val()
                        );
                        if (pollInterval < 5) {
                            pollInterval = 5;
                        }
                    } catch (error) {
                        pollInterval = 60;
                    }
                    $(this).find('input[name="hubname"]').val(hubName);
                    myenergiHubs.push({
                        hubname: hubName,
                        username: userName,
                        password: password,
                        pollInterval: pollInterval,
                    });
                });
                const apiBaseUrl = $('input[name="apiBaseUrl"]').val();

                // $('#log').val(JSON.stringify(myenergiHubs));
                Homey.set('apiBaseUrl', apiBaseUrl, function (err) {
                    if (err) return Homey.alert(err);
                });
                Homey.set('myenergiHubs', myenergiHubs, function (err) {
                    if (err) return Homey.alert(err);
                });
            });

            Homey.get('myenergiHubs', function (err, hubs) {
                if (err) return Homey.alert(err);
                if (!hubs || hubs.length < 1) return;
                myenergiHubs = hubs;
                populateFields();
            });

            Homey.get('apiBaseUrl', function (err, apiBaseUrl) {
                if (err) return Homey.alert(err);
                if (!apiBaseUrl && apiBaseUrl !== '') {
                    apiBaseUrl = 'https://s18.myenergi.net';
                }
                $('input[name="apiBaseUrl"]').val(apiBaseUrl);
            });
        }
    </script>
</body>

</html>